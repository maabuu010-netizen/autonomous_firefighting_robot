# 📊 MAPPING - SƠ ĐỒ & HÌNH MINH HỌA\n\n---\n\n## **1. SƠ ĐỒ KIẾN TRÚC MAPPING**\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                      HARDWARE (Robot)                       │\n├─────────────────────────────────────────────────────────────┤\n│                                                             │\n│  ┌──────────┐   ┌──────────┐   ┌──────────┐              │\n│  │ Raspberry│   │  LiDAR   │   │ Motors   │              │\n│  │    Pi    │──→│ (RPL...)│   │ (bánh xe)│              │\n│  └──────────┘   └──────────┘   └──────────┘              │\n│                      │                  │                  │\n│                      ↓                  ↓                  │\n└─────────────────────────────────────────────────────────────┘\n                       ↓\n┌─────────────────────────────────────────────────────────────┐\n│                      ROS2 NODES                             │\n├─────────────────────────────────────────────────────────────┤\n│                                                             │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ 1. rplidar_node (LiDAR Driver)                       │ │\n│  │    └─→ Publish: /scan                               │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                          ↓                                   │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ 2. async_slam_toolbox_node (SLAM - Chính)          │ │\n│  │    ├─ Input: /scan (LiDAR)                          │ │\n│  │    ├─ Input: /tf (từ RSP)                           │ │\n│  │    ├─ Processing:                                   │ │\n│  │    │  • Scan Matching                               │ │\n│  │    │  • Loop Closing                                │ │\n│  │    │  • Map Optimization                            │ │\n│  │    └─ Output: /map, /tf (map→base_footprint)       │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                          ↓                                   │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ 3. robot_state_publisher (RSP)                      │ │\n│  │    └─→ Publish: /tf (base_footprint→laser, etc.)   │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                          ↓                                   │\n└─────────────────────────────────────────────────────────────┘\n                       ↓\n┌─────────────────────────────────────────────────────────────┐\n│                  VISUALIZATION (RViz)                       │\n├─────────────────────────────────────────────────────────────┤\n│                                                             │\n│  ┌─────────────────────────────────────────────────────┐  │\n│  │  RViz                                               │  │\n│  │  ┌─────────────────────────────────────────────┐   │  │\n│  │  │  Map Layer (từ /map)                        │   │  │\n│  │  │  ■■■■■■■■■■  ← Bản đồ (đen = chướng ngại) │   │  │\n│  │  │  ░░░░░░░░░░  ← (xám = chưa biết)          │   │  │\n│  │  │                                             │   │  │\n│  │  │  LaserScan Layer (từ /scan)                │   │  │\n│  │  │  ..........  ← Dữ liệu laser (đỏ/vàng)   │   │  │\n│  │  │                                             │   │  │\n│  │  │  TF Layer                                   │   │  │\n│  │  │  → Robot position (mũi tên)                │   │  │\n│  │  └─────────────────────────────────────────────┘   │  │\n│  └─────────────────────────────────────────────────────┘  │\n│                                                             │\n└─────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## **2. LUỒNG DỮ LIỆU CHI TIẾT**\n\n```\n┌──────────┐\n│  LiDAR   │  Phát tia laser 2000+ lần/vòng\n└────┬─────┘  Tần số: ~8Hz (RPLiDAR S2)\n     │\n     │ Dữ liệu laser: [khoảng_cách_1, khoảng_cách_2, ...]\n     ↓\n┌──────────────────────────┐\n│  rplidar_node            │\n│  (LiDAR Driver)          │\n└────┬─────────────────────┘\n     │\n     │ Topic: /scan\n     │ (LaserScan message)\n     ↓\n┌──────────────────────────────────┐\n│  SLAM Toolbox                    │\n│                                  │\n│  Step 1: Nhận /scan              │\n│  ├─ Kiểm tra di chuyển đủ?      │\n│  │  (distance > 0.5m OR heading > 0.5rad)\n│  │\n│  Step 2: Scan Matching           │\n│  ├─ So sánh scan hiện tại vs     │\n│  │  scan trước                   │\n│  ├─ Tìm điểm khớp               │\n│  ├─ Tính robot di chuyển        │\n│  │  (dx, dy, dθ)                 │\n│  │\n│  Step 3: Update Map              │\n│  ├─ Chuyển laser scan → grid     │\n│  ├─ Cộng dữ liệu vào bản đồ     │\n│  │\n│  Step 4: Loop Detection          │\n│  ├─ Tìm scan cũ (> 3m trước)    │\n│  ├─ Nếu khớp → Loop Closing      │\n│  │\n│  Step 5: Optimization            │\n│  ├─ Solver: CeresSolver          │\n│  ├─ Giảm lỗi tích lũy           │\n│  │\n│  Step 6: Publish Results         │\n│  └─ /map, /tf                    │\n└────┬─────────────────────────────┘\n     │\n     ├─ /map (OccupancyGrid)\n     │  ├─ width: 2000 cells\n     │  ├─ height: 2000 cells\n     │  ├─ resolution: 0.05 m/cell\n     │  └─ data: [0, 0, ..., 100, 100, ...]\n     │     (0=trống, 100=chướng ngại, -1=chưa biết)\n     │\n     ├─ /map_metadata\n     │  ├─ resolution: 0.05\n     │  ├─ width: 2000\n     │  └─ height: 2000\n     │\n     └─ /tf (Transform)\n        └─ map → base_footprint\n           └─ translation: [-0.5, -0.3, 0.0]\n\n                ↓\n        ┌─────────────────┐\n        │  RViz           │\n        │  Hiển thị bản đồ│\n        └─────────────────┘\n```\n\n---\n\n## **3. HỆ TỌA ĐỘ (FRAMES)**\n\n```\n        map (toàn cục - SLAM tính toán)\n         ↓ ← transform từ SLAM\n        odom (từ odometry - bánh xe)\n         ↓ ← từ RSP (fixed)\n        base_footprint (chân robot)\n         ↓ ← từ URDF\n        base_link (tâm robot)\n         ├─ lidar_link\n         ├─ camera_link\n         └─ [các joint khác]\n\n\nVd: Robot ở vị trí (x=1.5m, y=2.3m, θ=45°) trong bản đồ\n\nmap\n  │\n  │ (tx=1.5, ty=2.3, tz=0, rz=45°)\n  ↓\nodom\n  │\n  │ (fixed, từ rsp.launch.py)\n  ↓\nbase_footprint\n  │\n  │ (từ URDF robot_core.xacro)\n  ↓\nbase_link ← Đây là tâm robot\n  │\n  └─ lidar_link ← LiDAR phát tia từ đây\n```\n\n---\n\n## **4. MAPPING PROCESS - HÌNH ẢNH**\n\n```\n╔════════════════════════════════════════════════╗\n║ LẦN 1: Robot vừa khởi động                    ║\n╚════════════════════════════════════════════════╝\n\nMap (trống):              Robot:          Scan:\n  ░░░░░░░░░░              (0,0,0°)         ........\n  ░░░░░░░░░░               ↑              .---------.\n  ░░░░░░░░░░             (Scan)          |  LiDAR  |\n  ░░░░░░░░░░                             '---------'\n\nÝ nghĩa: Bản đồ rỗng (░=unknown), robot ở (0,0), LiDAR quét xung quanh\n\n\n╔════════════════════════════════════════════════╗\n║ LẦN 2: Robot di chuyển 0.5m                    ║\n╚════════════════════════════════════════════════╝\n\nMap (thêm dữ liệu):     Robot (0.5m):   Scan matching:\nMap 1:  ░░░░░░░░░░          ↑          Scan 1 ←→ Scan 2\n        ░░■■■■░░░░       (Scan 2)      (so khớp)\n        ░░■■■■░░░░                     (khớp!)\n        ░░░░░░░░░░\n\nÝ nghĩa: Bản đồ được cập nhật (■=chướng ngại), robot ở (0.5,0)\nScan 2 được so khớp với Scan 1 → tính chuyển động\n\n\n╔════════════════════════════════════════════════╗\n║ LẦN 3+: Robot tiếp tục di chuyển & quay       ║\n╚════════════════════════════════════════════════╝\n\nMap (hoàn chỉnh):       Robot vị trí:   Loop Closing:\n  ■■■■■■■■■■■■           (1.0,-0.5)\n  ■░░░░░░░░░░■            ▼          Scan cũ ←→ Scan hiện tại\n  ■░░■■░░░░░■           (quay lại)    (khớp! → đóng vòng)\n  ■░░■■░░░░░■\n  ■■■■■■■■■■■■\n\nÝ nghĩa: Bản đồ có hình dáng phòng, robot quay lại chỗ cũ\n→ Loop closing kích hoạt → fix lỗi tích lũy\n\n\n╔════════════════════════════════════════════════╗\n║ KẾT QUẢ CUỐI: Bản đồ hoàn chỉnh                ║\n╚════════════════════════════════════════════════╝\n\n  ■■■■■■■■■■■■■■■■\n  ■░░░░░░░░░░░░░░░■\n  ■░  ┌──────────┐░■\n  ■░  │   Phòng  │░■\n  ■░  │  1       │░■\n  ■░  └──────────┘░■\n  ■░░░░░░░░░░░░░░░■\n  ■░  ┌──────────┐░■\n  ■░  │   Phòng  │░■\n  ■░  │  2       │░■\n  ■░  └──────────┘░■\n  ■░░░░░░░░░░░░░░░■\n  ■■■■■■■■■■■■■■■■\n\n■ = Tường (chướng ngại)\n░ = Khu vực trống\nRobot di chuyển qua tất cả → Bản đồ chi tiết\n```\n\n---\n\n## **5. SCAN MATCHING CHI TIẾT**\n\n```\n        Scan N-1                  Scan N\n      (Trước đó)              (Hiện tại)\n\n     Tia laser:              Tia laser:\n     ..........              ...........\n    /          \\            /           \\\n   |            |          |             |\n    \\          /  ← Chướng  \\           /  ← Chướng\n     ''''''''''  ngại vật     '''''''''' ngại vật\n\n       SLAM: \"So sánh 2 scan này\"\n\n       Scan N-1:          Scan N:\n       Điểm A (2.0m, 30°) Điểm A' (2.0m, 35°)\n       Điểm B (1.5m, 90°) Điểm B' (1.5m, 90°)\n       Điểm C (3.0m, 150°) Điểm C' (3.0m, 155°)\n\n       Kết luận:\n       • Điểm B khớp hoàn hảo\n       • Các điểm khác lệch 5° ≈ robot xoay 5° hoặc di chuyển\n       • → Robot di chuyển: (Δx, Δy, Δθ)\n```\n\n---\n\n## **6. LOOP CLOSING MINH HỌA**\n\n```\nTình huống: Robot vẽ hình U\n\nThời gian t=0 (Start):       Thời gian t=1 (Quay lại):\n  S                          S───────────┐\n  │                          │           │\n  │                          │      E←───┘\n  │                          │\n  └────→  (Scan 1)           └────→\n\nScan cũ (start): Quét mọi cạnh của phòng\nScan mới (return): Cảm biến giống hệt Scan cũ (quay lại chỗ cũ)\n\nLOOP CLOSING KÍCH HOẠT:\n  1. Phát hiện: Scan mới giống Scan cũ (khoảng 3m trước)\n  2. Xác nhận: Cần 10+ scan liên tiếp khớp\n  3. Kích hoạt: Sửa lỗi tích lũy\n  \nKết quả:\n  Bản đồ \"khép lại\"\n  S───────────────E\n  │               │\n  │               │\n  │               │\n  └───────────────┘\n  \n  (Thay vì S──────┐\n               │\n               └────E lệch)\n```\n\n---\n\n## **7. 5 TERMINAL MAPPING**\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                        LAPTOP/DESKTOP                       │\n├─────────────────────────────────────────────────────────────┤\n│                                                             │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ Terminal 1: RSP (Robot State Publisher)             │ │\n│  │ $ ros2 launch ... rsp.launch.py                     │ │\n│  │ [INFO] Publishing transforms...                     │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                          ↓                                   │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ Terminal 2: LiDAR                                   │ │\n│  │ $ ros2 launch ... rplidar.launch.py                 │ │\n│  │ [INFO] RPLIDAR S2 started                           │ │\n│  │ [INFO] /scan topic published                        │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                          ↓                                   │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ Terminal 3: SLAM Toolbox (Chính yếu!)              │ │\n│  │ $ ros2 launch ... online_async_launch.py            │ │\n│  │ [INFO] Starting SLAM...                             │ │\n│  │ [INFO] /map topic published                         │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                          ↓                                   │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ Terminal 4: RViz (Hiển thị)                         │ │\n│  │ $ rviz2 -d map.rviz                                 │ │\n│  │ [Hiển thị bản đồ, laser scan, robot position]      │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                          ↓                                   │\n│  ┌──────────────────────────────────────────────────────┐ │\n│  │ Terminal 5: Control                                 │ │\n│  │ $ ros2 topic pub /cmd_vel ...                       │ │\n│  │ [Robot di chuyển]                                  │ │\n│  └──────────────────────────────────────────────────────┘ │\n│                                                             │\n└─────────────────────────────────────────────────────────────┘\n                      ROS2 Network\n                           ↓\n┌─────────────────────────────────────────────────────────────┐\n│                    Raspberry Pi                             │\n│                   (Robot thật)                              │\n├─────────────────────────────────────────────────────────────┤\n│  LiDAR → rplidar_node → /scan\n│  Motors ← cmd_vel\n│  RSP running\n│  SLAM running\n└─────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## **8. MAPPING vs LOCALIZATION**\n\n```\n┌──────────────────────┐        ┌──────────────────────┐\n│     MAPPING MODE      │        │  LOCALIZATION MODE   │\n├──────────────────────┤        ├──────────────────────┤\n│                      │        │                      │\n│  Input: /scan        │        │  Input: /scan        │\n│         (LiDAR)      │        │         (LiDAR)      │\n│                      │        │                      │\n│  Load: Bản đồ cũ?    │        │  Load: Bản đồ cũ ✓   │\n│         KHÔNG        │        │         CÓ (tải lên) │\n│                      │        │                      │\n│  Process:            │        │  Process:            │\n│  ┌─────────────────┐│        │ ┌─────────────────┐  │\n│  │ Vẽ bản đồ mới   ││        │ │ Định vị trên bản│  │\n│  │ từ đầu          ││        │ │ đồ cũ (không vẽ│  │\n│  │ (append data)   ││        │ │ mới)            │  │\n│  └─────────────────┘│        │ └─────────────────┘  │\n│                      │        │                      │\n│  Output:             │        │  Output:             │\n│  ┌─────────────────┐│        │ ┌─────────────────┐  │\n│  │ /map (mới)      ││        │ │ /tf (vị trí)    │  │\n│  │ (phát triển)    ││        │ │ (định vị)       │  │\n│  └─────────────────┘│        │ └─────────────────┘  │\n│                      │        │                      │\n│  Thích hợp:          │        │  Thích hợp:          │\n│  ✓ Lần đầu          │        │  ✓ Điều hướng (Nav2) │\n│  ✓ Khu vực mới      │        │  ✓ Robot biết nơi   │\n│  ✓ Cập nhật bản đồ  │        │    nó ở đâu         │\n│                      │        │                      │\n└──────────────────────┘        └──────────────────────┘\n\nQUI TRÌNH:\n\n  Lần 1: MAPPING → Lưu bản đồ\n         mapping_mode: true\n         output: my_robot_map.pgm + .yaml\n                 \n  Lần 2: LOCALIZATION → Định vị\n         localization_mode: true\n         map_file: my_robot_map\n         output: robot position (/tf)\n                 \n  Lần 3: NAVIGATION → Điều hướng\n         load localization + Nav2\n         robot → tự động đi đến goal\n```\n\n---\n\n## **9. SỬ DỤNG BẢN ĐỒ ĐÃ LƯU**\n\n```\nFile lưu (sau mapping):\n\n  my_robot_map.pgm     ← Ảnh bản đồ (grayscale)\n  ┌──────────────────────┐\n  │■■■■■■■■■■■■■■■■■■■■│\n  │■░░░░░░░░░░░░░░░░░░░■│  ■ = Tường (255)\n  │■░  ┌────────────┐░░░■│  ░ = Trống (0)\n  │■░  │   Phòng   │░░░■│  ? = Chưa biết (-1)\n  │■░  └────────────┘░░░■│\n  │■░░░░░░░░░░░░░░░░░░░■│\n  └──────────────────────┘\n\n  my_robot_map.yaml    ← Metadata\n  {\n    image: my_robot_map.pgm\n    resolution: 0.05      ← 1 pixel = 5cm\n    origin: [-50.0, -50.0, 0.0]  ← Góc dưới trái\n    occupied_thresh: 0.65  ← Tường\n    free_thresh: 0.196     ← Trống\n  }\n\nCách dùng lại:\n\n  1. Sửa config (mapper_params_online_async.yaml):\n     mode: localization\n     map_file_name: /home/pi/my_robot_map\n     \n  2. Bật SLAM:\n     ros2 launch ... online_async_launch.py\n     \n  3. SLAM load bản đồ + định vị robot trong bản đồ\n     \n  4. Dùng Nav2 → robot tự động đi\n```\n\n---\n\n## **10. RESOLUTION - MINH HỌA**\n\n```\nResolution: 0.05m (5cm)\n\n┌─┬─┬─┬─┬─┐\n├─┼─┼─┼─┼─┤  Mỗi ô = 5cm × 5cm\n├─┼─┼─┼─┼─┤  \n├─┼─┼─┼─┼─┤  100cm × 100cm = 20 × 20 ô\n├─┼─┼─┼─┼─┤\n└─┴─┴─┴─┴─┘\n  ← 5cm →\n\nResolution: 0.1m (10cm)\n\n┌───┬───┬───┐\n├───┼───┼───┤  Mỗi ô = 10cm × 10cm\n├───┼───┼───┤  \n├───┼───┼───┤  100cm × 100cm = 10 × 10 ô\n├───┼───┼───┤\n└───┴───┴───┘\n  ← 10cm →\n\n┌─────────┐\n│ 0.05m   │ Chi tiết cao, tốn bộ nhớ\n│ (5cm)   │ Phù hợp: phòng nhỏ/chi tiết\n└─────────┘\n\n┌─────────┐\n│ 0.1m    │ Cân bằng (KHUYẾN NGHỊ)\n│ (10cm)  │ Phù hợp: đa số case\n└─────────┘\n\n┌─────────┐\n│ 0.2m    │ Kém chi tiết, nhanh\n│ (20cm)  │ Phù hợp: khu vực rất lớn\n└─────────┘\n```\n\n---\n\n**Các sơ đồ này giúp bạn hình dung rõ ràng cách Mapping hoạt động! 🎨**\n"
